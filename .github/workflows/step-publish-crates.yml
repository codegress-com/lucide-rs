#
# Crates Publishing Workflow
#
# This workflow publishes the shadcn-rust CLI package to crates.io.
# It handles authentication and publishes the package using the workspace version.
#
# Triggered: Called by other workflows (workflow_call)
# Purpose: Publish CLI package to the official Rust package registry
#

name: ‚öôÔ∏è Publish to Crates.io

on:
  # Allow this workflow to be called by other workflows
  workflow_call:
    inputs:
      ref:
        description: "Git ref to publish from (tag, branch, or commit)"
        required: false
        type: string
        default: "main"
      dry_run:
        description: "Perform a dry run without actually publishing"
        required: false
        type: boolean
        default: false

# Environment variables
env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Publish CLI package to crates.io
  publish-cli:
    name: Publish shadcn-rust CLI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Verify package configuration
        run: |
          echo "Verifying package configuration..."

          # Check that the CLI package exists and has correct version
          cargo metadata --format-version=1 | jq -r '.packages[] | select(.name == "shadcn-rust") | "\(.name) v\(.version)"'

          # Verify package.metadata is correct
          echo "Package metadata:"
          cargo metadata --format-version=1 | jq '.packages[] | select(.name == "shadcn-rust") | .metadata'

      - name: Run dry-run publish
        if: ${{ inputs.dry_run == true }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          echo "üß™ Running dry-run publish..."
          cargo publish -p shadcn-rust --dry-run --allow-dirty
          echo "‚úÖ Dry-run completed successfully"

      - name: Publish to crates.io
        if: ${{ inputs.dry_run != true }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          echo "üì¶ Publishing shadcn-rust CLI to crates.io..."

          # Publish the CLI package
          cargo publish -p shadcn-rust --allow-dirty

          echo "‚úÖ Package published successfully to crates.io!"
          echo "üîó Available at: https://crates.io/crates/shadcn-rust"

      - name: Verify publication
        if: ${{ inputs.dry_run != true }}
        run: |
          echo "üîç Verifying publication..."

          # Wait a moment for crates.io to process
          sleep 30

          # Try to fetch the package info (may take a few minutes to be available)
          echo "Package should be available soon at https://crates.io/crates/shadcn-rust"

          echo "Installation command for users:"
          echo "  cargo install shadcn-rust"
